# Base image
FROM hpretl/iic-osic-tools:2025.03

# Set user-related build arguments
ARG UID=501
ARG GID=20
ARG USERNAME=designer

# Root user setup
USER root

# Install sudo and safely set up user/group
RUN apt update && apt install -y sudo && \
    if ! getent group $GID >/dev/null; then \
        addgroup --gid $GID $USERNAME; \
    fi && \
    adduser --uid $UID --gid $GID --disabled-password --gecos "" $USERNAME && \
    mkdir -p /home/$USERNAME && \
    mkdir -m 0755 /nix && \
    chown $UID:$GID /home/$USERNAME /nix && \
    echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Switch to user
USER $USERNAME
WORKDIR /home/$USERNAME

# Install vlsiffra Python package
RUN pip3 install --break-system-packages git+https://github.com/antonblanchard/vlsiffra

# Install system dependencies (non-interactive)
RUN sudo apt-get update && \
    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
        build-essential clang bison flex \
        libreadline-dev gawk tcl-dev libffi-dev git \
        graphviz xdot pkg-config python3 zlib1g-dev

# Install Python packages
RUN sudo apt-get install -y python3-click
